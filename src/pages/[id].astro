---
import PodcastLayout from "../layouts/PodcastLayout.astro";
import Headline from "../components/Headline.astro";
import Prose from "../components/Prose.astro";
import TranscriptDropdown from "../components/TranscriptDropdown.astro";
import AudioPlayer from "../components/AudioPlayer.astro";
import type { PodcastData } from "../types/podcast";
import { formatDate, buildMetaDescription } from "../utils/helpers";

import enPodcasts from "../data/podcasts/en.json";

export async function getStaticPaths() {
  const podcasts = (enPodcasts.podcasts as PodcastData[]).filter(
    (podcast) => podcast.isAvailable,
  );
  return podcasts.map((podcast) => ({
    params: { id: podcast.id },
  }));
}

const { id } = Astro.params;

const podcasts = (enPodcasts.podcasts as PodcastData[]).filter(
  (podcast) => podcast.isAvailable,
);
const currentPodcast = podcasts.find((podcast) => podcast.id === id);

if (!currentPodcast) {
  return Astro.redirect("/404");
}

function getNavigation() {
  const currentIndex = podcasts.findIndex((podcast) => podcast.id === id);

  if (currentIndex === -1) {
    return { prev: null, next: null };
  }

  return {
    prev: currentIndex > 0 ? podcasts[currentIndex - 1] : null,
    next:
      currentIndex < podcasts.length - 1 ? podcasts[currentIndex + 1] : null,
  };
}

const { prev, next } = getNavigation();
const episodeNumber = podcasts.findIndex((podcast) => podcast.id === id) + 1;
const metaDescription =
  currentPodcast.metaDescription ||
  buildMetaDescription(currentPodcast.description, 155);

const t = {
  backToAll: "‚Üê Back to all podcasts",
  listenToEpisode: "üéß Listen to Episode",
  episode: "Episode",
  previousEpisode: "Previous Episode",
  nextEpisode: "Next Episode",
  episodeNavigation: "Episode navigation",
  publishedOn: "Published on",
  duration: "Duration",
  musicHistory: "Music History",
  knowledge: "Knowledge article",
  readArticle: "Read the knowledge article",
  transcript: "Transcript",
  showTranscript: "Show Transcript",
  hideTranscript: "Hide Transcript",
  loading: "Loading transcript...",
  notAvailable: "Transcript not available",
  error: "Error loading transcript",
};
---

<PodcastLayout
  title={currentPodcast.title}
  description={metaDescription}
  type="article"
  publishedTime={currentPodcast.publishedAt}
  modifiedTime={currentPodcast.publishedAt}
  image={`/square/${currentPodcast.imageUrl}.jpg`}
  episodeImage={`/square/${currentPodcast.imageUrl}.jpg`}
  language="en"
  locale="en-US"
  episodeNumber={episodeNumber}
  durationSeconds={currentPodcast.durationSeconds}
  audioUrl={currentPodcast.audioUrl}
  keywords={[
    currentPodcast.title.toLowerCase(),
    t.musicHistory.toLowerCase(),
    "music podcast",
    "audio story",
    "music history",
  ]}
  canonical={`https://podcasts.melody-mind.de/${currentPodcast.id}`}
>
  <div class="episode">
    <nav class="episode__breadcrumb" aria-label="Breadcrumb navigation">
      <a
        href="/"
        class="episode__breadcrumb-link"
        aria-label="Go back to all podcasts"
      >
        {t.backToAll}
      </a>
    </nav>

    <section class="episode__hero" aria-labelledby="episode-title">
      <div class="episode__hero-media">
        <img
          src={`/images/${currentPodcast.imageUrl}.jpg`}
          alt={`Cover artwork for ${currentPodcast.title} podcast episode`}
          width="400"
          height="267"
          loading="eager"
          class="episode__hero-image"
          decoding="async"
        />
      </div>

      <div class="episode__hero-body">
        <div class="episode__meta">
          <span
            class="episode__pill"
            aria-label={`${t.episode} number ${episodeNumber}`}
          >
            {t.episode} {episodeNumber}
          </span>
          <time
            class="episode__date"
            datetime={currentPodcast.publishedAt}
            aria-label={`${t.publishedOn} ${formatDate(currentPodcast.publishedAt)}`}
          >
            {t.publishedOn} {formatDate(currentPodcast.publishedAt)}
          </time>
        </div>

        <Headline level="h1" textSize="2xl" className="episode__title">
          <span id="episode-title">{currentPodcast.title}</span>
        </Headline>

        <p class="episode__description">{currentPodcast.description}</p>
      </div>
    </section>

    {currentPodcast.knowledgeUrl && (
      <section
        class="episode__knowledge"
        aria-labelledby="knowledge-link"
      >
        <div class="episode__knowledge-body">
          <p class="episode__kicker" id="knowledge-link">
            {t.knowledge}
          </p>
          <p class="episode__knowledge-text">
            Deepen your dive with the related Melody Mind knowledge article.
          </p>
        </div>
        <a
          href={currentPodcast.knowledgeUrl}
          class="episode__knowledge-link"
          target="_blank"
          rel="noopener noreferrer"
          aria-label={`${t.readArticle}: ${currentPodcast.title}`}
        >
          {t.readArticle}
        </a>
      </section>
    )}

    {currentPodcast.audioUrl && (
      <section class="episode__audio" aria-labelledby="audio-player-heading">
        <Headline level="h2" textSize="lg" className="episode__section-title">
          <span id="audio-player-heading">{t.listenToEpisode}</span>
        </Headline>

        <AudioPlayer
          title={currentPodcast.title}
          audioUrl={currentPodcast.audioUrl}
          subtitleUrl={currentPodcast.subtitleUrl}
        />
      </section>
    )}

    <TranscriptDropdown
      subtitleUrl={currentPodcast.subtitleUrl}
      podcastTitle={currentPodcast.title}
    />

    {currentPodcast.showNotesHtml && (
      <section class="episode__notes" aria-labelledby="show-notes-heading">
        <Headline level="h2" textSize="xl" className="episode__section-title">
          <span id="show-notes-heading">Show Notes</span>
        </Headline>
        <article role="region" aria-labelledby="show-notes-heading">
          <Prose html={currentPodcast.showNotesHtml} size="lg" />
        </article>
      </section>
    )}

    {(prev || next) && (
      <nav class="episode__nav" aria-labelledby="episode-nav-heading">
        <h2 id="episode-nav-heading" class="episode__sr-only">{t.episodeNavigation}</h2>
        <div class="episode__nav-grid">
          {prev && (
            <a
              href={`/${prev.id}`}
              class="episode__nav-card"
              aria-label={`Go to previous episode: ${prev.title}`}
            >
              <span class="episode__nav-direction" aria-hidden="true">‚Üê</span>
              <div class="episode__nav-body">
                <span class="episode__nav-label">
                  {t.previousEpisode}
                </span>
                <span class="episode__nav-title">{prev.title}</span>
              </div>
            </a>
          )}

          {next && (
            <a
              href={`/${next.id}`}
              class="episode__nav-card episode__nav-card--next"
              aria-label={`Go to next episode: ${next.title}`}
            >
              <div class="episode__nav-body">
                <span class="episode__nav-label">
                  {t.nextEpisode}
                </span>
                <span class="episode__nav-title">{next.title}</span>
              </div>
              <span class="episode__nav-direction" aria-hidden="true">‚Üí</span>
            </a>
          )}
        </div>
      </nav>
    )}
  </div>

</PodcastLayout>

<style>
  .episode {
    display: grid;
    gap: 2.5rem;
  }

  .episode__breadcrumb {
    margin-top: 0.25rem;
  }

  .episode__breadcrumb-link {
    display: inline-flex;
    align-items: center;
    padding: 0.6rem 1rem;
    border-radius: 0.8rem;
    background: var(--color-layer-1);
    border: 1px solid color-mix(in srgb, var(--color-primary) 25%, transparent);
    color: var(--color-text);
    text-decoration: none;
    font-weight: 600;
  }

  .episode__breadcrumb-link:focus-visible {
    outline: none;
    box-shadow: var(--focus-ring);
  }

  .episode__hero {
    display: grid;
    gap: 2rem;
  }

  .episode__hero-media {
    width: 100%;
  }

  .episode__hero-image {
    width: 100%;
    height: auto;
    border-radius: 1.5rem;
    border: 1px solid color-mix(in srgb, var(--color-primary) 25%, transparent);
    box-shadow: var(--shadow-soft);
    display: block;
  }

  .episode__hero-body {
    display: grid;
    gap: 1rem;
  }

  .episode__meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
  }

  .episode__pill {
    padding: 0.4rem 0.9rem;
    border-radius: 999px;
    background: var(--color-layer-2);
    border: 1px solid color-mix(in srgb, var(--color-primary) 30%, transparent);
    color: var(--color-text);
    font-weight: 700;
    font-size: 0.85rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .episode__date {
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    background: var(--color-layer-1);
    border: 1px solid color-mix(in srgb, var(--color-primary) 20%, transparent);
    color: var(--color-text-muted);
    font-size: 0.85rem;
  }

  .episode__title {
    margin-top: 0.25rem;
  }

  .episode__description {
    margin: 0;
    color: var(--color-text-muted);
    line-height: 1.7;
  }

  .episode__knowledge {
    padding: 1.5rem;
    border-radius: 1.25rem;
    background: var(--color-layer-1);
    border: 1px solid color-mix(in srgb, var(--color-primary) 25%, transparent);
    display: grid;
    gap: 1rem;
    align-items: center;
  }

  .episode__knowledge-body {
    display: grid;
    gap: 0.5rem;
  }

  .episode__kicker {
    margin: 0;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.25em;
    color: var(--color-text-muted);
  }

  .episode__knowledge-text {
    margin: 0;
    color: var(--color-text);
  }

  .episode__knowledge-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.6rem 1rem;
    border-radius: 0.75rem;
    background: var(--color-primary);
    color: var(--color-background);
    font-weight: 700;
    text-decoration: none;
  }

  .episode__knowledge-link:focus-visible {
    outline: none;
    box-shadow: var(--focus-ring);
  }

  .episode__audio {
    padding: 1.5rem;
    border-radius: 1.25rem;
    background: var(--color-layer-4);
    border: 1px solid color-mix(in srgb, var(--color-primary) 20%, transparent);
    display: grid;
    gap: 1rem;
  }

  .episode__notes {
    display: grid;
    gap: 1rem;
  }

  .episode__section-title {
    margin: 0;
  }

  .episode__nav {
    display: grid;
    gap: 1rem;
  }

  .episode__sr-only {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0 0 0 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
  }

  .episode__nav-grid {
    display: grid;
    gap: 1rem;
  }

  .episode__nav-card {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 1rem;
    padding: 1.1rem 1.25rem;
    border-radius: 1rem;
    background: var(--color-layer-1);
    border: 1px solid color-mix(in srgb, var(--color-primary) 25%, transparent);
    color: var(--color-text);
    text-decoration: none;
    box-shadow: var(--shadow-soft);
  }

  .episode__nav-card--next {
    grid-template-columns: 1fr auto;
    text-align: right;
  }

  .episode__nav-card:focus-visible {
    outline: none;
    box-shadow: var(--focus-ring);
  }

  .episode__nav-direction {
    font-size: 1.6rem;
    color: var(--color-primary);
  }

  .episode__nav-body {
    display: grid;
    gap: 0.25rem;
  }

  .episode__nav-label {
    text-transform: uppercase;
    letter-spacing: 0.15em;
    font-size: 0.7rem;
    color: var(--color-text-muted);
  }

  .episode__nav-title {
    font-weight: 700;
  }

  @media (min-width: 960px) {
    .episode__hero {
      grid-template-columns: 1fr 1.4fr;
      align-items: center;
    }

    .episode__knowledge {
      grid-template-columns: 1fr auto;
    }

    .episode__nav-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }
</style>
