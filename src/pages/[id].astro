---
import { Image } from "astro:assets";
import PodcastLayout from "../layouts/PodcastLayout.astro";
import Headline from "../components/Headline.astro";
import Prose from "../components/Prose.astro";
import TranscriptDropdown from "../components/TranscriptDropdown.astro";
import type { PodcastData } from "../types/podcast";
import { formatDate, buildMetaDescription } from "../utils/helpers";

import enPodcasts from "../data/podcasts/en.json";

export async function getStaticPaths() {
  const podcasts = (enPodcasts.podcasts as PodcastData[]).filter(
    (podcast) => podcast.isAvailable,
  );
  return podcasts.map((podcast) => ({
    params: { id: podcast.id },
  }));
}

const { id } = Astro.params;

const podcasts = (enPodcasts.podcasts as PodcastData[]).filter(
  (podcast) => podcast.isAvailable,
);
const currentPodcast = podcasts.find((podcast) => podcast.id === id);

if (!currentPodcast) {
  return Astro.redirect("/404");
}

function getNavigation() {
  const currentIndex = podcasts.findIndex((podcast) => podcast.id === id);

  if (currentIndex === -1) {
    return { prev: null, next: null };
  }

  return {
    prev: currentIndex > 0 ? podcasts[currentIndex - 1] : null,
    next:
      currentIndex < podcasts.length - 1 ? podcasts[currentIndex + 1] : null,
  };
}

const { prev, next } = getNavigation();
const episodeNumber = podcasts.findIndex((podcast) => podcast.id === id) + 1;
const metaDescription =
  currentPodcast.metaDescription ||
  buildMetaDescription(currentPodcast.description, 155);

const t = {
  backToAll: "‚Üê Back to all podcasts",
  listenToEpisode: "üéß Listen to Episode",
  episode: "Episode",
  previousEpisode: "Previous Episode",
  nextEpisode: "Next Episode",
  episodeNavigation: "Episode navigation",
  publishedOn: "Published on",
  duration: "Duration",
  musicHistory: "Music History",
  transcript: "Transcript",
  showTranscript: "Show Transcript",
  hideTranscript: "Hide Transcript",
  loading: "Loading transcript...",
  notAvailable: "Transcript not available",
  error: "Error loading transcript",
};
---

<PodcastLayout
  title={currentPodcast.title}
  description={metaDescription}
  type="article"
  publishedTime={currentPodcast.publishedAt}
  modifiedTime={currentPodcast.publishedAt}
  image={`/square/${currentPodcast.imageUrl}.jpg`}
  episodeImage={`/square/${currentPodcast.imageUrl}.jpg`}
  language="en"
  locale="en-US"
  episodeNumber={episodeNumber}
  durationSeconds={currentPodcast.durationSeconds}
  audioUrl={currentPodcast.audioUrl}
  keywords={[
    currentPodcast.title.toLowerCase(),
    t.musicHistory.toLowerCase(),
    "music podcast",
    "audio story",
    "music history",
  ]}
  canonical={`https://podcasts.melody-mind.de/${currentPodcast.id}`}
>
  <nav class="mb-8" aria-label="Breadcrumb navigation">
    <a
      href="/"
      class="inline-flex items-center gap-2 rounded-lg px-4 py-3 text-sm font-semibold text-purple-400 transition-all duration-300 hover:-translate-x-1 hover:bg-purple-500/10 hover:text-purple-300 focus:bg-purple-500/10 focus:text-purple-300 border border-purple-500/20 hover:border-purple-400/40 focus:border-purple-400/40 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-offset-2 focus:ring-offset-slate-900"
      aria-label="Go back to all podcasts"
    >
      {t.backToAll}
    </a>
  </nav>

  <section class="mb-12" aria-labelledby="episode-title">
    <div class="mb-8 flex flex-col gap-10 text-center md:text-left lg:flex-row">
      <div class="relative w-full flex-shrink-0 lg:w-96">
        <div class="group relative aspect-[3/2] w-full overflow-hidden">
          <Image
            src={`/images/${currentPodcast.imageUrl}.jpg`}
            alt={`Cover artwork for ${currentPodcast.title} podcast episode`}
            width={400}
            height={267}
            format="webp"
            quality={90}
            loading="eager"
            class="absolute inset-0 h-full w-full overflow-hidden rounded-2xl object-cover transition-transform duration-300 group-hover:scale-105"
            decoding="async"
          />
        </div>
      </div>

      <div class="flex-1">
        <div class="mb-6 flex flex-wrap items-center justify-start gap-3 text-sm">
          <span
            class="inline-flex items-center justify-center rounded-full bg-gradient-to-r from-purple-600 to-indigo-600 px-4 py-2 text-sm font-bold tracking-wider text-white shadow-lg ring-1 ring-white/10"
            aria-label={`${t.episode} number ${episodeNumber}`}
          >
            {t.episode} {episodeNumber}
          </span>
          <time
            class="inline-flex items-center gap-2 rounded-full bg-gray-800 px-3 py-1 text-gray-300"
            datetime={currentPodcast.publishedAt}
            aria-label={`${t.publishedOn} ${formatDate(currentPodcast.publishedAt)}`}
          >
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            {t.publishedOn} {formatDate(currentPodcast.publishedAt)}
          </time>
        </div>

        <Headline level="h1" textSize="2xl" className="mb-4">
          <span id="episode-title">{currentPodcast.title}</span>
        </Headline>

        <div class="prose prose-lg prose-invert prose-slate max-w-none mb-6">
          <p>{currentPodcast.description}</p>
        </div>
      </div>
    </div>

    {currentPodcast.audioUrl && (
      <section class="rounded-2xl text-center shadow-xl" aria-labelledby="audio-player-heading">
        <div class="mb-6 rounded-xl border border-gray-600 bg-gray-900 p-6 shadow-inner">
          <Headline level="h2" textSize="lg" className="mb-6 text-center text-white">
            <span id="audio-player-heading">{t.listenToEpisode}</span>
          </Headline>

          <div class="mb-4 flex flex-col items-center justify-center gap-4 md:flex-row md:items-center">
            <div class="relative">
              <button
                id="play-button"
                aria-label={`Play ${currentPodcast.title} episode`}
                aria-describedby="audio-status"
                title={`Play ${currentPodcast.title}`}
                class="flex h-12 w-12 items-center justify-center rounded-full bg-purple-600 shadow-lg transition-transform duration-150 hover:scale-105 focus:scale-105 focus:ring-4 focus:ring-purple-400 focus:outline-none md:h-16 md:w-16"
              >
                <svg width="32" height="32" viewBox="0 0 24 24" fill="white" aria-hidden="true">
                  <path d="M8 5v14l11-7z" />
                </svg>
              </button>

              <button
                id="pause-button"
                aria-label={`Pause ${currentPodcast.title} episode`}
                aria-describedby="audio-status"
                title={`Pause ${currentPodcast.title}`}
                class="hidden h-12 w-12 items-center justify-center rounded-full bg-purple-600 shadow-lg transition-transform duration-150 hover:scale-105 focus:scale-105 focus:ring-4 focus:ring-purple-400 focus:outline-none md:h-16 md:w-16"
              >
                <svg width="32" height="32" viewBox="0 0 24 24" fill="white" aria-hidden="true">
                  <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                </svg>
              </button>
            </div>

            <div class="text-center md:text-left">
              <div
                class="text-lg font-semibold text-white"
                id="audio-status"
                aria-live="polite"
                aria-atomic="true"
              >
                {currentPodcast.title}
              </div>
            </div>
          </div>

          <audio
            id="audio-player"
            preload="metadata"
            class="hidden"
            aria-label={`Audio player for ${currentPodcast.title}`}
            data-title={currentPodcast.title}
            crossorigin="anonymous"
          >
            <source src={currentPodcast.audioUrl} type="audio/mpeg" />
            {currentPodcast.subtitleUrl && (
              <track
                kind="captions"
                src={currentPodcast.subtitleUrl}
                srclang="en"
                label="English"
                default
              />
            )}
            Your browser does not support the audio element.
          </audio>

          <div class="mb-4 w-full">
            <label for="progress-bar" class="sr-only">Audio progress</label>
            <div
              id="progress-bar"
              role="slider"
              aria-label="Audio progress"
              aria-valuemin="0"
              aria-valuemax="100"
              aria-valuenow="0"
              tabindex="0"
              class="relative h-3 w-full cursor-pointer rounded-full bg-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-300 focus:ring-offset-2 focus:ring-offset-gray-900 ring-1 ring-gray-600"
            >
              <div
                id="progress-fill"
                class="absolute top-0 left-0 h-3 rounded-full bg-gradient-to-r from-purple-400 via-indigo-400 to-blue-400 shadow-[0_0_0_1px_rgba(255,255,255,0.1)] transition-[width] duration-150 ease-out"
                style="width:0%"
                aria-hidden="true"
              />
            </div>
          </div>

          <div class="mb-4 flex flex-col items-center gap-2 text-sm text-gray-400 md:flex-row md:justify-center md:gap-4">
            <span id="time-display" aria-live="polite" aria-label="Current playback time">0:00 / 0:00</span>
            <span id="shortcut-hint" class="hidden text-xs text-gray-500 md:inline" aria-live="polite">
              Press ? for shortcuts (Space, ‚Üê/‚Üí, Home/End)
            </span>
          </div>

            <div class="flex items-center justify-center gap-6" role="group" aria-label="Audio player controls">
              <button
                class="text-gray-400 transition-colors duration-200 hover:text-white focus:text-white focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-offset-2 focus:ring-offset-gray-900 rounded-md p-1"
                id="rewind-button"
                aria-label="Rewind 10 seconds"
                title="Rewind 10 seconds"
              >
                <svg class="h-5 w-5 md:h-6 md:w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z" />
                </svg>
              </button>

              <button
                class="text-gray-400 transition-colors duration-200 hover:text-white focus:text-white focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-offset-2 focus:ring-offset-gray-900 rounded-md p-1"
                id="forward-button"
                aria-label="Forward 10 seconds"
                title="Forward 10 seconds"
              >
                <svg class="h-5 w-5 md:h-6 md:w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 5V1l5 5-5 5V7c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6h2c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8z" />
                </svg>
              </button>
          </div>
        </div>
      </section>
    )}

    <TranscriptDropdown
      subtitleUrl={currentPodcast.subtitleUrl}
      podcastTitle={currentPodcast.title}
    />
  </section>

  {currentPodcast.showNotesHtml && (
    <section class="mb-12" aria-labelledby="show-notes-heading">
      <Headline level="h2" textSize="xl" className="mb-4 text-white">
        <span id="show-notes-heading">Show Notes</span>
      </Headline>
      <article role="region" aria-labelledby="show-notes-heading">
        <Prose html={currentPodcast.showNotesHtml} size="lg" />
      </article>
    </section>
  )}

  {(prev || next) && (
    <nav class="mb-12" aria-labelledby="episode-nav-heading">
      <h2 id="episode-nav-heading" class="sr-only">{t.episodeNavigation}</h2>
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
        {prev && (
          <a
            href={`/${prev.id}`}
            class="flex items-center gap-4 rounded-xl border border-gray-700 bg-gray-800 p-6 text-white shadow-lg transition-all duration-300 hover:-translate-y-1 hover:border-gray-600 hover:bg-gray-700 hover:shadow-xl focus:-translate-y-1 focus:border-gray-600 focus:bg-gray-700 focus:shadow-xl focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-offset-2 focus:ring-offset-slate-900"
            aria-label={`Go to previous episode: ${prev.title}`}
          >
            <span class="text-2xl text-purple-400" aria-hidden="true">‚Üê</span>
            <div class="flex-1">
              <span class="mb-1 block text-xs tracking-wide text-gray-400 uppercase">
                {t.previousEpisode}
              </span>
              <span class="block text-base leading-tight font-semibold">{prev.title}</span>
            </div>
          </a>
        )}

        {next && (
          <a
            href={`/${next.id}`}
            class="flex items-center gap-4 rounded-xl border border-gray-700 bg-gray-800 p-6 text-white shadow-lg transition-all duration-300 hover:-translate-y-1 hover:border-gray-600 hover:bg-gray-700 hover:shadow-xl focus:-translate-y-1 focus:border-gray-600 focus:bg-gray-700 focus:shadow-xl focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-offset-2 focus:ring-offset-slate-900 md:col-start-2"
            aria-label={`Go to next episode: ${next.title}`}
          >
            <div class="flex-1 text-right">
              <span class="mb-1 block text-xs tracking-wide text-gray-400 uppercase">
                {t.nextEpisode}
              </span>
              <span class="block text-base leading-tight font-semibold">{next.title}</span>
            </div>
            <span class="text-2xl text-purple-400" aria-hidden="true">‚Üí</span>
          </a>
        )}
      </div>
    </nav>
  )}

  <script>
    import { initSimpleAudioPlayer } from "../utils/audioPlayer";
    document.addEventListener("DOMContentLoaded", () => {
      const player = document.getElementById("audio-player");
      if (!player) return;
      initSimpleAudioPlayer();
    });
  </script>
</PodcastLayout>
