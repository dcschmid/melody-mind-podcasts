---
const { total } = Astro.props as { total: number };

const labels = {
  placeholder: "Search episodes",
  label: "Search episodes",
  results: "results",
  resultOne: "result",
  clear: "Clear search",
  hint: "Type to filter episodes. Matches title & description.",
  empty: "No matching episodes.",
  statusTemplate: "Found: {found} of {total} {word}",
};
---
<form
  role="search"
  class="search-bar mb-10 max-w-3xl mx-auto"
  aria-label={labels.label}
  onsubmit="event.preventDefault()"
  aria-controls="episodes-list"
>
  <div class="flex gap-3 items-stretch">
    <div class="relative flex-1">
      <label for="episode-search" class="visually-hidden">{labels.label}</label>
      <input
        id="episode-search"
        name="q"
        type="search"
        inputmode="search"
        autocomplete="off"
        placeholder={labels.placeholder}
        aria-describedby="search-hint"
        class="w-full rounded-lg bg-gray-800 border border-purple-500/40 focus:border-purple-400 px-4 py-3 text-base text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-offset-2 focus:ring-offset-gray-900"
        oninput="filterEpisodes(this.value)"
      />
      <button
        type="button"
        aria-label={labels.clear}
        onclick="clearSearch()"
        class="absolute right-2 top-1/2 -translate-y-1/2 px-2 py-1 text-sm rounded-md text-gray-300 hover:text-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-purple-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900"
      >
        Ã—
      </button>
    </div>
  </div>
  <p id="search-hint" class="mt-2 text-xs text-gray-400" aria-hidden="true">
    {labels.hint}
  </p>
  <div
    aria-live="polite"
    aria-atomic="true"
    id="search-status"
    class="mt-2 text-sm text-purple-300"
    data-total={total}
  >
    {labels.statusTemplate
      .replace("{found}", String(total))
      .replace("{total}", String(total))
      .replace("{word}", total === 1 ? labels.resultOne : labels.results)}
  </div>
  <div
    id="search-empty"
    class="mt-2 text-sm text-red-300 hidden"
    role="status"
  >
    {labels.empty}
  </div>
</form>
<script>
  const minChars = 1;
  function normalizeText(str) {
    return str.trim().toLowerCase();
  }
  function filterEpisodes(query) {
    const q = normalizeText(query);
    const items = Array.from(document.querySelectorAll("[data-episode]"));
    let shown = 0;
    if (q.length < minChars) {
      items.forEach((el) => {
        if (el instanceof HTMLElement) {
          el.hidden = false;
          el.setAttribute("tabindex", "0");
        }
      });
      shown = items.length;
    } else {
      items.forEach((el) => {
        const hay = normalizeText(el.getAttribute("data-search") || "");
        const match = hay.indexOf(q) !== -1;
        if (el instanceof HTMLElement) {
          el.hidden = !match;
          if (match) {
            shown++;
            el.setAttribute("tabindex", "0");
          } else {
            el.removeAttribute("tabindex");
          }
        }
      });
    }
    updateStatus(shown);
  }
  function updateStatus(count) {
    const status = document.getElementById("search-status");
    const empty = document.getElementById("search-empty");
    if (status) {
      const total = status.getAttribute("data-total") || "0";
      const word = count === 1 ? "result" : "results";
      status.textContent = `Found: ${count} of ${total} ${word}`;
    }
    if (empty) {
      empty.classList.toggle("hidden", count !== 0);
    }
  }
  function clearSearch() {
    const input = document.getElementById("episode-search");
    if (input instanceof HTMLInputElement) {
      input.value = "";
      input.focus();
      filterEpisodes("");
    }
  }
  document.addEventListener("DOMContentLoaded", () => {
    const total = document.querySelectorAll("[data-episode]").length;
    updateStatus(total);
  });
  (window as any).filterEpisodes = filterEpisodes;
  (window as any).clearSearch = clearSearch;
</script>
<style>
  .visually-hidden {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0 0 0 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
  }
</style>
