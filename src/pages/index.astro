---
import PodcastLayout from "../layouts/PodcastLayout.astro";
import SearchBar from "../components/SearchBar.astro";
import EpisodeCard from "../components/EpisodeCard.astro";
import HomeHero from "../components/HomeHero.astro";
import type { PodcastData } from "../types/podcast";

import enPodcasts from "../data/podcasts/en.json";

const podcasts = (enPodcasts.podcasts as PodcastData[]).filter(
  (podcast) => podcast.isAvailable,
);

const t = {
  title: "MelodyMind Podcasts",
  subtitle: "Feel-good music journeys with Daniel & Annabelle",
  description:
    "Settle in, press play, and wander through the stories behind the songs. Daniel & Annabelle take you from vinyl crackle to streaming sheen — meeting rebels, dreamers, and legends along the way. No dusty archive: just warm, human stories, surprising facts, and playlists you’ll want to save.",
  seoDescription:
    "Discover music history through expert podcasts. Explore decades of musical evolution, from 1950s rock 'n' roll to modern streaming. Premium audio content featuring legendary artists, cultural movements, and industry insights.",
  episodes: "Episodes",
  listen: "Listen Now",
  featuredContent:
    "Discover the voices, rhythms, and revolutions that defined generations",
  totalEpisodes: " episodes available",
  availableOn: "Available on your favorite platforms:",
  spotifyUrl: "https://open.spotify.com/show/6iLbxIzJ4x5nMuuK5qySOQ",
  deezerUrl: "https://www.deezer.com/en/show/1002446242",
  youtubeUrl:
    "https://www.youtube.com/playlist?list=PLioOQ4LuNFxtx2d70QKywiPC8WVBxgXN0",
  keywords: [
    "music history podcast",
    "rock and roll",
    "music culture",
    "vintage music",
    "music documentary",
    "audio stories",
  ],
};
---

<PodcastLayout
  title={t.title}
  description={t.seoDescription}
  keywords={t.keywords}
  type="website"
  language="en"
  locale="en-US"
  seriesDescription={t.seoDescription}
>
  <div class="home">
    <HomeHero
      title={t.title}
      subtitle={t.subtitle}
      description={t.description}
      totalEpisodes={podcasts.length}
      featuredContent={t.featuredContent}
      availableOn={t.availableOn}
      spotifyUrl={t.spotifyUrl}
      deezerUrl={t.deezerUrl}
    />

    <SearchBar total={podcasts.length} />

    <section class="home__episodes" aria-labelledby="episodes-heading">
      <h2 id="episodes-heading" class="home__section-title">
        {t.episodes}
      </h2>

      <div
        class="home__episodes-grid"
        role="list"
        id="episodes-list"
      >
        {
          podcasts.map((podcast) => (
            <EpisodeCard
              id={podcast.id}
              title={podcast.title}
              description={podcast.description}
              imageUrl={podcast.imageUrl}
              durationSeconds={podcast.durationSeconds}
              searchText={`${podcast.title} ${podcast.description}`}
            />
          ))
        }
      </div>
    </section>
  </div>

  <script is:inline>
    (() => {
      const form = document.querySelector(".search-bar");
      if (!form) return;

      const input = form.querySelector(".search-bar__input");
      const clearButton = form.querySelector(".search-bar__clear");
      const status = form.querySelector("#search-status");
      const empty = form.querySelector("#search-empty");
      const items = Array.from(document.querySelectorAll("[data-episode]"));

      const normalize = (value) => value.trim().toLowerCase();

      const updateStatus = (count) => {
        if (status) {
          const total = status.getAttribute("data-total") || "0";
          const word = count === 1 ? "result" : "results";
          status.textContent = `Found: ${count} of ${total} ${word}`;
        }
        if (empty) {
          empty.hidden = count !== 0;
        }
      };

      const filter = (value) => {
        const query = normalize(value);
        let shown = 0;

        if (!query) {
          items.forEach((el) => {
            if (el instanceof HTMLElement) {
              el.hidden = false;
              el.setAttribute("tabindex", "0");
              el.setAttribute("aria-hidden", "false");
            }
          });
          shown = items.length;
        } else {
          items.forEach((el) => {
            const hay = normalize(el.getAttribute("data-search") || "");
            const match = hay.includes(query);
            if (el instanceof HTMLElement) {
              el.hidden = !match;
              if (match) {
                shown += 1;
                el.setAttribute("tabindex", "0");
                el.setAttribute("aria-hidden", "false");
              } else {
                el.removeAttribute("tabindex");
                el.setAttribute("aria-hidden", "true");
              }
            }
          });
        }

        updateStatus(shown);
      };

      form.addEventListener("submit", (event) => event.preventDefault());

      input?.addEventListener("input", (event) => {
        filter(event.target.value);
      });

      clearButton?.addEventListener("click", () => {
        if (input instanceof HTMLInputElement) {
          input.value = "";
          input.focus();
          filter("");
        }
      });

      updateStatus(items.length);
    })();
  </script>
</PodcastLayout>

<style>
  .home {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .home__episodes {
    display: grid;
    gap: 1.5rem;
  }

  .home__section-title {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 800;
    background: var(--brand-gradient);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
  }

  .home__episodes-grid {
    display: grid;
    gap: 1.25rem;
  }

  @media (min-width: 768px) {
    .home__episodes-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (min-width: 1200px) {
    .home__episodes-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }
</style>
