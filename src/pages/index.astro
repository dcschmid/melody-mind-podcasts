---
import PodcastLayout from '../layouts/PodcastLayout.astro';
import SearchBar from '../components/SearchBar.astro';
import EpisodeCard from '../components/EpisodeCard.astro';
import HomeHero from '../components/HomeHero.astro';
import episodesScript from '../scripts/episodes.ts?url';
import type { PodcastData } from '../types/podcast';
import { formatDate } from '../utils/helpers';

import { getAvailablePodcasts } from '../utils/podcasts';

const podcasts: PodcastData[] = await getAvailablePodcasts();
const sortedPodcasts = [...podcasts].sort(
  (a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime(),
);
const normalizeSearchText = (value: string) => value.toLowerCase().replace(/\s+/g, ' ').trim();
const pageSize = 30;
const episodeEntries = sortedPodcasts.map((podcast, index) => ({
  id: podcast.id,
  title: podcast.title,
  description: podcast.description,
  imageUrl: podcast.imageUrl,
  durationSeconds: podcast.durationSeconds,
  publishedAt: podcast.publishedAt,
  publishedLabel: formatDate(podcast.publishedAt),
  isLatest: index === 0,
  searchText: normalizeSearchText(`${podcast.title} ${podcast.description}`),
}));
const initialEpisodes = episodeEntries.slice(0, pageSize);
const templateEpisode = episodeEntries[0];
const serializedEpisodes = JSON.stringify(episodeEntries).replace(/</g, '\\u003c');
const encodedEpisodes = Buffer.from(serializedEpisodes, 'utf8').toString('base64');

const t = {
  title: 'MelodyMind Podcasts',
  seoTitle: 'MelodyMind Podcasts — Music History Podcast with Daniel & Annabelle',
  subtitle: 'A music history podcast with Daniel & Annabelle',
  description:
    "Welcome to MelodyMind Podcasts — a music history podcast that traces the stories, scenes, and artists shaping each decade. Daniel & Annabelle guide you from 1950s rock 'n' roll to modern streaming with thoughtful listening and cultural context.",
  seoDescription:
    "Official site of MelodyMind Podcasts, a music history podcast with Daniel & Annabelle. Explore decade-by-decade episodes from 1950s rock 'n' roll to today.",
  episodes: 'Episodes',
  listen: 'Listen Now',
  featuredContent:
    'Discover the voices, rhythms, and revolutions that defined each decade of music',
  totalEpisodes: ' episodes available',
  availableOn: 'Available on your favorite platforms:',
  spotifyUrl: 'https://open.spotify.com/show/6iLbxIzJ4x5nMuuK5qySOQ',
  deezerUrl: 'https://www.deezer.com/en/show/1002446242',
  youtubeUrl: 'https://www.youtube.com/channel/UCD7MQkWw4P5Pd5xA_o6McLg',
  keywords: [
    'melodymind podcasts',
    'music history podcast',
    'daniel and annabelle',
    'music decades',
    'rock and roll',
    'music culture',
    'vintage music',
    'music documentary',
    'audio stories',
  ],
};
---

<PodcastLayout
  title={t.seoTitle}
  description={t.seoDescription}
  keywords={t.keywords}
  type="website"
  language="en"
  locale="en-US"
  seriesDescription={t.seoDescription}
>
  <div class="home">
    <HomeHero
      title={t.title}
      subtitle={t.subtitle}
      description={t.description}
      totalEpisodes={podcasts.length}
      featuredContent={t.featuredContent}
      availableOn={t.availableOn}
      spotifyUrl={t.spotifyUrl}
      deezerUrl={t.deezerUrl}
      youtubeUrl={t.youtubeUrl}
    />

    <SearchBar total={podcasts.length} />

    <section class="home__episodes" aria-labelledby="episodes-heading">
      <h2 id="episodes-heading" class="home__section-title">
        {t.episodes}
      </h2>

      <div class="home__episodes-grid" role="list" id="episodes-list">
        {
          initialEpisodes.map((podcast) => (
            <EpisodeCard
              id={podcast.id}
              title={podcast.title}
              description={podcast.description}
              imageUrl={podcast.imageUrl}
              durationSeconds={podcast.durationSeconds}
              searchText={podcast.searchText}
              publishedAt={podcast.publishedAt}
              publishedLabel={podcast.publishedLabel}
              isLatest={podcast.isLatest}
            />
          ))
        }
      </div>
      <div id="episodes-data" data-episodes={encodedEpisodes} hidden></div>
      {
        templateEpisode && (
          <div id="episode-template" hidden>
            <EpisodeCard
              id={templateEpisode.id}
              title={templateEpisode.title}
              description={templateEpisode.description}
              imageUrl={templateEpisode.imageUrl}
              durationSeconds={templateEpisode.durationSeconds}
              searchText={templateEpisode.searchText}
              publishedAt={templateEpisode.publishedAt}
              publishedLabel={templateEpisode.publishedLabel}
              isLatest={templateEpisode.isLatest}
            />
          </div>
        )
      }
      <div class="home__load-more" id="episodes-load-more" hidden>
        <div class="home__load-more-panel" role="group" aria-label="Load more episodes">
          <p class="home__load-more-status" id="episodes-load-more-status" aria-live="polite">
            Showing {Math.min(pageSize, podcasts.length)} of {podcasts.length} episodes.
          </p>
          <button
            class="home__load-more-button"
            id="episodes-load-more-button"
            type="button"
            aria-controls="episodes-list"
          >
            Load more
          </button>
        </div>
      </div>
    </section>
  </div>

  <script type="module" src={episodesScript}></script>
</PodcastLayout>

<style>
  .home {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .home__episodes {
    display: grid;
    gap: 1.5rem;
  }

  .home__section-title {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 800;
    color: transparent;
    text-shadow: 0 10px 26px rgb(2 6 13 / 60%);
    background: var(--brand-gradient);
    -webkit-background-clip: text;
    background-clip: text;
  }

  .home__episodes-grid {
    display: grid;
    grid-template-columns: minmax(0, 1fr);
    gap: 0;
    border-block-start: 1px solid var(--card-divider);
  }

  .home__load-more {
    display: grid;
    justify-items: center;
    margin-block-start: 1.5rem;
  }

  .home__load-more-panel {
    display: grid;
    gap: 0.85rem;
    justify-items: center;
    inline-size: min(28rem, 100%);
    padding: 1.1rem 1.5rem;
    background: linear-gradient(
      150deg,
      color-mix(in srgb, var(--color-layer-2) 92%, transparent),
      color-mix(in srgb, var(--color-layer-1) 95%, transparent)
    );
    border: 1px solid color-mix(in srgb, var(--color-primary) 22%, transparent);
    border-radius: 1.25rem;
    box-shadow:
      0 22px 50px rgb(2 8 18 / 45%),
      0 0 0 1px rgb(120 200 255 / 8%);
  }

  .home__load-more-status {
    margin: 0;
    font-size: 0.95rem;
    color: var(--color-text-muted);
    text-align: center;
  }

  @media screen and (prefers-reduced-motion: reduce) {
    .home__load-more-button {
      padding: 0.65rem 1.35rem;
      font-weight: 700;
      color: var(--color-text);
      cursor: pointer;
      background: linear-gradient(
        135deg,
        color-mix(in srgb, var(--color-primary) 35%, var(--color-layer-1)),
        color-mix(in srgb, var(--color-primary) 22%, var(--color-layer-2))
      );
      border: 1px solid color-mix(in srgb, var(--color-primary) 28%, transparent);
      border-radius: 999px;
      transition: none;
    }
  }

  .home__load-more-button {
    padding: 0.65rem 1.35rem;
    font-weight: 700;
    color: var(--color-text);
    cursor: pointer;
    background: linear-gradient(
      135deg,
      color-mix(in srgb, var(--color-primary) 35%, var(--color-layer-1)),
      color-mix(in srgb, var(--color-primary) 22%, var(--color-layer-2))
    );
    border: 1px solid color-mix(in srgb, var(--color-primary) 28%, transparent);
    border-radius: 999px;
    transition:
      transform 0.2s ease,
      box-shadow 0.2s ease,
      border-color 0.2s ease;
  }

  .home__load-more-button:focus-visible {
    outline: none;
    box-shadow: var(--focus-ring);
  }

  .home__load-more-button:hover,
  .home__load-more-button:focus {
    border-color: color-mix(in srgb, var(--color-primary) 50%, transparent);
    box-shadow: 0 12px 24px rgb(2 8 18 / 40%);
    transform: translateY(-1px);
  }

  .home__load-more-button[disabled] {
    cursor: not-allowed;
    box-shadow: none;
    opacity: 0.55;
    transform: none;
  }
</style>
