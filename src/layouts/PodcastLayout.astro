---
import Footer from '../components/Footer.astro';

export interface Props {
  title: string;
  description: string;
  image?: string;
  type?: 'website' | 'article';
  publishedTime?: string;
  modifiedTime?: string;
  author?: string;
  keywords?: string[];
  canonical?: string;
  language?: string;
  locale?: string;
  episodeNumber?: number;
  durationSeconds?: number | undefined;
  audioUrl?: string;
  episodeImage?: string;
  seriesDescription?: string;
}

const {
  title,
  description,
  image = '/images/default-og.jpg',
  type = 'website',
  publishedTime,
  modifiedTime,
  author = 'MelodyMind Podcasts',
  keywords = [],
  canonical,
  language = 'en',
  locale = 'en-US',
  episodeNumber,
  durationSeconds,
  audioUrl,
  episodeImage,
  seriesDescription,
} = Astro.props;

const siteTitle = 'MelodyMind Podcasts';
const normalizedTitle = normalizeMetaText(title);
const fullTitle = normalizedTitle.toLowerCase().includes(siteTitle.toLowerCase())
  ? normalizedTitle
  : `${normalizedTitle} | ${siteTitle}`;
const siteUrl = 'https://podcasts.melody-mind.de';
const currentPath = canonical ? canonical.replace(siteUrl, '') : Astro.url.pathname;
const currentUrl = `${siteUrl}${ensureTrailingSlash(currentPath)}`;
const imageUrl = image.startsWith('http') ? image : `${siteUrl}${image}`;
const episodeImageUrl = episodeImage
  ? episodeImage.startsWith('http')
    ? episodeImage
    : `${siteUrl}${episodeImage}`
  : imageUrl;
const podcastFeedUrl = `${siteUrl}/podcast.xml`;
const podcastImage = `${siteUrl}/the-melody-mind-podcast.jpg`;
const seriesCopy =
  seriesDescription ||
  'Melody Mind explores the stories behind the music that shaped generations, hosted by Daniel and Annabelle.';
const genres = ['Music', 'History'];
const defaultKeywords = ['podcast', 'music history', 'audio', 'streaming', 'entertainment'];
const allKeywords = [...defaultKeywords, ...keywords].join(', ');
const skipLinkText = 'Skip to main content';
const normalizedDescription = normalizeMetaText(description);
const imageAlt =
  type === 'article' ? `Cover artwork for ${normalizedTitle}` : `Cover artwork for ${siteTitle}`;

const publisher = {
  '@type': 'Organization',
  name: 'MelodyMind Podcasts',
  url: siteUrl,
  logo: {
    '@type': 'ImageObject',
    url: podcastImage,
  },
};

const podcastSeriesJson = {
  '@context': 'https://schema.org',
  '@type': 'PodcastSeries',
  name: siteTitle,
  description: seriesCopy,
  url: siteUrl,
  inLanguage: locale,
  image: podcastImage,
  genre: genres,
  isAccessibleForFree: true,
  sameAs: [
    'https://open.spotify.com/show/6iLbxIzJ4x5nMuuK5qySOQ',
    'https://www.deezer.com/en/show/1002446242',
    'https://podcasts.apple.com/us/podcast/melody-mind-â€“-english/id1847445333',
  ],
  publisher,
  webFeed: podcastFeedUrl,
  author: [
    {
      '@type': 'Person',
      name: 'Daniel Schmid',
      url: 'https://melody-mind.de',
    },
    {
      '@type': 'Person',
      name: 'Annabelle',
    },
  ],
  potentialAction: {
    '@type': 'SearchAction',
    target: {
      '@type': 'EntryPoint',
      urlTemplate: `${siteUrl}/?q={search_term_string}`,
    },
    'query-input': 'required name=search_term_string',
  },
};

const episodeDurationIso =
  typeof durationSeconds === 'number' && durationSeconds > 0
    ? toIsoDuration(durationSeconds)
    : undefined;

const podcastEpisodeJson =
  type === 'article'
    ? {
        '@context': 'https://schema.org',
        '@type': 'PodcastEpisode',
        name: title,
        description: normalizedDescription,
        url: currentUrl,
        partOfSeries: {
          '@type': 'PodcastSeries',
          name: siteTitle,
          url: siteUrl,
        },
        episodeNumber,
        datePublished: publishedTime,
        dateModified: modifiedTime || publishedTime,
        inLanguage: locale,
        image: episodeImageUrl,
        genre: genres,
        isAccessibleForFree: true,
        timeRequired: episodeDurationIso,
        author: [
          {
            '@type': 'Person',
            name: 'Daniel Schmid',
            url: 'https://melody-mind.de',
          },
          {
            '@type': 'Person',
            name: 'Annabelle',
          },
        ],
        audio: audioUrl
          ? {
              '@type': 'AudioObject',
              url: audioUrl,
              encodingFormat: 'audio/mpeg',
              duration: episodeDurationIso,
            }
          : undefined,
        publisher,
      }
    : undefined;

const jsonLd = [podcastSeriesJson, podcastEpisodeJson].filter(Boolean);

function ensureTrailingSlash(pathname: string) {
  if (!pathname.startsWith('/')) {
    return `/${pathname}/`;
  }
  return pathname.endsWith('/') ? pathname : `${pathname}/`;
}

function normalizeMetaText(value: string) {
  return value.replace(/\s+/g, ' ').trim();
}

function toIsoDuration(totalSeconds: number) {
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = Math.floor(totalSeconds % 60);
  return `PT${hours > 0 ? `${hours}H` : ''}${minutes > 0 ? `${minutes}M` : ''}${seconds || (!hours && !minutes) ? `${seconds}S` : ''}`;
}
---

<!doctype html>
<html lang={language} data-view-transition>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0b1119" />
    <meta name="color-scheme" content="dark" />
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Melody Mind Podcasts" />
    <meta name="google-site-verification" content="ImN0-TS4_aAOFIXaGxvsGSmqsgHxI94WARi8bW7fm9M" />

    <link rel="manifest" href="/site.webmanifest" />

    <title>{fullTitle}</title>
    <meta name="title" content={fullTitle} />
    <meta name="description" content={normalizedDescription} />
    <meta name="keywords" content={allKeywords} />
    <meta name="author" content={author} />
    <meta
      name="robots"
      content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"
    />
    <meta name="language" content={language} />
    <meta name="revisit-after" content="7 days" />

    <link rel="canonical" href={currentUrl} />
    <link rel="sitemap" type="application/xml" href="/sitemap-index.xml" />

    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />

    <meta property="og:type" content={type} />
    <meta property="og:url" content={currentUrl} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={normalizedDescription} />
    <meta property="og:image" content={imageUrl} />
    <meta property="og:image:alt" content={imageAlt} />
    <meta property="og:site_name" content={siteTitle} />
    <meta property="og:locale" content={locale.replace('-', '_')} />
    {publishedTime && <meta property="article:published_time" content={publishedTime} />}
    {modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}
    {type === 'article' && <meta property="article:author" content={author} />}

    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={currentUrl} />
    <meta property="twitter:title" content={fullTitle} />
    <meta property="twitter:description" content={normalizedDescription} />
    <meta property="twitter:image" content={imageUrl} />
    <meta name="twitter:image:alt" content={imageAlt} />
    <meta property="twitter:creator" content="@melodymind" />
    <meta property="twitter:site" content="@melodymind" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="RSS Feed - English"
      href="/podcast.xml"
      hreflang={locale}
    />

    <link rel="dns-prefetch" href="//cdn.usefathom.com" />
    <script src="https://cdn.usefathom.com/script.js" data-site="IGOFKHTB" defer></script>
    <script
      type="application/ld+json"
      set:html={JSON.stringify(
        jsonLd.map((entry) => ({
          ...entry,
          potentialAction:
            type === 'website'
              ? {
                  '@type': 'SearchAction',
                  target: `${siteUrl}/?q={search_term_string}`,
                  'query-input': 'required name=search_term_string',
                }
              : undefined,
        })),
      )}
    />
  </head>
  <body class="podcast-layout" id="top">
    <div class="podcast-layout__container">
      <a href="#main-content" class="podcast-layout__skip-link">
        {skipLinkText}
      </a>

      <main id="main-content" role="main" class="podcast-layout__main">
        <slot />
      </main>

      <Footer />
    </div>
  </body>
</html>

<style>
  /* Font: Atkinson Hyperlegible - loaded locally for consistency with Melody Mind */
  @font-face {
    font-family: "Atkinson Hyperlegible";
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: url("/fonts/atkinson-hyperlegible-regular.woff2") format("woff2");
  }

  /* Global minimum font size of 18px for better readability */
  :root {
    font-size: 112.5%; /* 18px = 1rem at standard browser settings */

    /* Line height tokens for harmonious typography */
    --leading-tight: 1.25;
    --leading-normal: 1.5;
    --leading-relaxed: 1.75;
    --leading-enhanced: 1.8;

    /* Typography scale tokens */
    --font-size-caption: 1rem;
    --font-size-ui: 1.0625rem;
    --font-size-body: 1.125rem;
    --font-size-body-strong: 1.25rem;
    --font-size-title-sm: 1.5rem;
    --font-size-title-md: 1.75rem;
    --font-size-title-lg: 2.25rem;
    --font-size-hero: clamp(2.5rem, 4.4vw, 3.35rem);
  }

  .podcast-layout {
    --color-primary: #6fe1ff;
    --color-primary-strong: #bff2ff;
    --color-secondary: #3ad1ff;
    --color-contrast: #b3efff;
    --color-background: #0b1119;
    --color-surface: #111a24;
    --color-surface-2: #141f2b;
    --color-layer-1: #141f2b;
    --color-layer-2: #182535;
    --color-layer-3: #1b2a3d;
    --color-layer-4: #0f1621;
    --color-text: #f7fbff;
    --color-text-muted: #e2ecf8;
    --color-error-soft: #ffb7c5;
    --color-error-strong: #ffd3dc;
    --brand-gradient: linear-gradient(110deg, #b3efff 0%, #6fe1ff 45%, #3ad1ff 90%);
    --shadow-soft: 0 20px 50px rgb(2 6 13 / 45%);
    --shadow-strong: 0 30px 80px rgb(2 6 13 / 70%);
    --focus-ring: 0 0 0 3px #fff, 0 0 0 6px #6fe1ff;
    --max-width: 72rem;

    min-block-size: 100vb;
    margin: 0;
    font-family: "Atkinson Hyperlegible", system-ui, sans-serif;
    font-size: 1.25rem;
    line-height: var(--leading-relaxed);
    color: var(--color-text);
    letter-spacing: 0.01em;
    background-color: var(--color-background);
    background-image:
      radial-gradient(circle at 15% 20%, rgb(79 211 255 / 8%), transparent 35%),
      radial-gradient(circle at 85% 10%, rgb(44 198 255 / 8%), transparent 32%),
      radial-gradient(circle at 70% 70%, rgb(138 217 255 / 6%), transparent 40%);
    text-rendering: optimizelegibility;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-wrap: pretty;
  }

  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }

  .podcast-layout__container {
    display: grid;
    gap: 2.5rem;
    max-inline-size: var(--max-width);
    padding-block: clamp(2rem, 4vi, 3.5rem);
    padding-inline: clamp(1.25rem, 3vi, 2.5rem);
    margin: 0 auto;
  }

  .podcast-layout__main {
    outline: none;
  }

  .podcast-layout__skip-link {
    position: absolute;
    inset-block-start: auto;
    inset-inline-start: -9999px;
    inline-size: 1px;
    block-size: 1px;
    overflow: hidden;
  }

  .podcast-layout__skip-link:focus,
  .podcast-layout__skip-link:focus-visible {
    inset-block-start: 1rem;
    inset-inline-start: 1rem;
    z-index: 100;
    inline-size: auto;
    block-size: auto;
    padding: 0.5rem 1rem;
    color: var(--color-background);
    outline: 2px solid #fff;
    outline-offset: 2px;
    background: var(--color-primary);
    border-radius: 0.5rem;
    box-shadow: var(--shadow-soft);
  }

  @media (width >= 640px) {
    .podcast-layout__container {
      padding: 2.5rem 1.5rem 4rem;
    }
  }

  @media (width <= 380px) {
    .podcast-layout__container {
      padding-inline: 0.85rem;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      transition-duration: 0.01ms !important;
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      scroll-behavior: auto !important;
    }
  }
</style>
